<style>
    .form-container {
        width: 80%;
        max-width: 600px;
        background-color: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-height: 70vh;
        overflow-y: auto;
        margin-bottom: 20px;
        position: relative;
    }




    .form-container label {
        display: flex;
        align-items: center;
        margin-top: 20px;
        font-weight: bold;
        text-align: center;
        font-size: 2rem;
        cursor: pointer;
        justify-content: space-between; /* Ensure label and arrow are aligned */
    }




    .form-container input,
    .form-container select,
    .form-container textarea {
        width: calc(100% - 40px);
        padding: 20px;
        margin-top: 10px;
        margin-bottom: 40px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 2rem;
    }




    .form-container textarea {
        resize: vertical;
        height: 200px;
    }




    .form-container button {
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 1.5rem;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-right: 10px;
    }




    .form-container button:hover {
        background-color: #d32f2f;
    }




    /* Initially hide skills and feats sections */
    .skills-section,
    .feats-section,
    .abilities-section {
        display: none;
        flex-direction: column;
        align-items: flex-start;
        font-size: 2rem;
        width: 100%;
    }




    .skills-section div,
    .feats-section div,
    .abilities-section div {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        justify-content: flex-start;
        width: auto;
        white-space: nowrap;
    }




    .skills-section div input[type="checkbox"],
    .feats-section div input[type="checkbox"],
    .abilities-section div input[type="checkbox"] {
        margin-right: 2rem;
        transform: scale(2);
        margin-left: 0;
    }




    .skills-section div label,
    .feats-section div label,
    .abilities-section div label {
        margin-bottom: 0;
        margin-left: 0.5rem;
        text-align: left;
        line-height: 1.5;
        white-space: nowrap;
    }


    .ability-description {
        font-size: 1.4rem;
        color: #666;
        font-weight: normal;
        margin-top: 0.3rem;
        line-height: 1.3;
        display: block;
    }




    /* Arrow icon next to label */
    .arrow {
        margin-left: 10px;
        transition: transform 0.3s ease;
    }




    .arrow.open {
        transform: rotate(90deg); /* Rotate when open */
    }




    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        background-color: #fff;
        width: 100%;
        top: auto;
        bottom: 100%;
        left: 0;
        right: 0;
        max-height: 150px;
        overflow-y: auto;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    }




    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }




    .autocomplete-items div:hover {
        background-color: #e9e9e9;
    }




    .autocomplete-active {
        background-color: DodgerBlue !important;
        color: #ffffff;
    }




    .custom-move-chip {
        display: inline-block;
        padding: 3px 8px;
        margin: 3px;
        background-color: #f44336;
        color: white;
        border-radius: 15px;
        font-size: 1rem;
        cursor: pointer;
    }




    .custom-move-chip span {
        margin-left: 10px;
        font-weight: bold;
        cursor: pointer;
    }




    .popup {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
    }




    .popup-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }




    .popup-button {
        margin-top: 20px;
        margin-right: 10px;
        padding: 10px 20px;
        font-size: 1.2rem;
        background-color: #f44336;
        color: #ffffff;            
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
</style>




<h1>Edit Pokémon</h1>
<div class="form-container">
    <form id="editPokemonForm" onsubmit="submitForm(event)">
        <label for="level">Level</label>
        <input type="number" id="level" name="level" required />




        <label for="hd">HD</label>
        <input type="number" id="hd" name="hd" required />




        <label for="vd">VD</label>
        <input type="number" id="vd" name="vd" required />




        <label for="str">STR</label>
        <input type="number" id="str" name="str" required />




        <label for="dex">DEX</label>
        <input type="number" id="dex" name="dex" required />




        <label for="con">CON</label>
        <input type="number" id="con" name="con" required />




        <label for="int">INT</label>
        <input type="number" id="int" name="int" required />




        <label for="wis">WIS</label>
        <input type="number" id="wis" name="wis" required />




        <label for="cha">CHA</label>
        <input type="number" id="cha" name="cha" required />




        <label for="loyalty">Loyalty</label>
        <input type="number" id="loyalty" name="loyalty" required />




        <label for="abilities" class="collapsible">
            Abilities
            <span class="arrow" id="abilitiesArrow">▶</span>
        </label>
        <div id="abilities" class="abilities-section">
            <!-- Abilities will be populated dynamically -->
        </div>




        <label for="nature">Nature</label>
        <select id="nature" name="nature" required></select>




        <label for="skills">Skills
            <span class="arrow" id="skillsArrow">▶</span> <!-- Arrow icon -->
        </label>
        <div id="skills" class="skills-section">
            <div>
                <input type="checkbox" id="athletics" name="skills" value="Athletics" />
                <label for="athletics">Athletics (STR)</label>
            </div>
            <div>
                <input type="checkbox" id="acrobatics" name="skills" value="Acrobatics" />
                <label for="acrobatics">Acrobatics (DEX)</label>
            </div>
            <!-- Add other skills here -->
            <div>
                <input type="checkbox" id="sleightOfHand" name="skills" value="Sleight of Hand" />
                <label for="sleightOfHand">Sleight of Hand (DEX)</label>
            </div>
            <div>
                <input type="checkbox" id="stealth" name="skills" value="Stealth" />
                <label for="stealth">Stealth (DEX)</label>
            </div>
            <div>
                <input type="checkbox" id="arcana" name="skills" value="Arcana" />
                <label for="arcana">Arcana (INT)</label>
            </div>
            <div>
                <input type="checkbox" id="history" name="skills" value="History" />
                <label for="history">History (INT)</label>
            </div>
            <div>
                <input type="checkbox" id="investigation" name="skills" value="Investigation" />
                <label for="investigation">Investigation (INT)</label>
            </div>
            <div>
                <input type="checkbox" id="nature" name="skills" value="Nature" />
                <label for="nature">Nature (INT)</label>
            </div>
            <div>
                <input type="checkbox" id="religion" name="skills" value="Religion" />
                <label for="religion">Religion (INT)</label>
            </div>
            <div>
                <input type="checkbox" id="animalHandling" name="skills" value="Animal Handling" />
                <label for="animalHandling">Animal Handling (WIS)</label>
            </div>
            <div>
                <input type="checkbox" id="insight" name="skills" value="Insight" />
                <label for="insight">Insight (WIS)</label>
            </div>
            <div>
                <input type="checkbox" id="medicine" name="skills" value="Medicine" />
                <label for="medicine">Medicine (WIS)</label>
            </div>
            <div>
                <input type="checkbox" id="perception" name="skills" value="Perception" />
                <label for="perception">Perception (WIS)</label>
            </div>
            <div>
                <input type="checkbox" id="survival" name="skills" value="Survival" />
                <label for="survival">Survival (WIS)</label>
            </div>
            <div>
                <input type="checkbox" id="deception" name="skills" value="Deception" />
                <label for="deception">Deception (CHA)</label>
            </div>
            <div>
                <input type="checkbox" id="intimidation" name="skills" value="Intimidation" />
                <label for="intimidation">Intimidation (CHA)</label>
            </div>
            <div>
                <input type="checkbox" id="performance" name="skills" value="Performance" />
                <label for="performance">Performance (CHA)</label>
            </div>
            <div>
                <input type="checkbox" id="persuasion" name="skills" value="Persuasion" />
                <label for="persuasion">Persuasion (CHA)</label>
            </div>
        </div>




        <label for="feats">Feats
            <span class="arrow" id="featsArrow">▶</span> <!-- Arrow icon -->
        </label>
        <div id="feats" class="feats-section">
            <div>
                <input type="checkbox" id="acrobat" name="feats" value="Acrobat" />
                <label for="acrobat">Acrobat</label>
            </div>
            <div>
                <input type="checkbox" id="actor" name="feats" value="Actor" />
                <label for="actor">Actor</label>
            </div>
            <div>
                <input type="checkbox" id="alert" name="feats" value="Alert" />
                <label for="alert">Alert</label>
            </div>
            <div>
                <input type="checkbox" id="athlete" name="feats" value="Athlete" />
                <label for="athlete">Athlete</label>
            </div>
            <div>
                <input type="checkbox" id="brawny" name="feats" value="Brawny" />
                <label for="brawny">Brawny</label>
            </div>
            <div>
                <input type="checkbox" id="charger" name="feats" value="Charger" />
                <label for="charger">Charger (When using melee attacks)</label>
            </div>
            <div>
                <input type="checkbox" id="durable" name="feats" value="Durable" />
                <label for="durable">Durable</label>
            </div>
            <div>
                <input type="checkbox" id="mobile" name="feats" value="Mobile" />
                <label for="mobile">Mobile</label>
            </div>
            <div>
                <input type="checkbox" id="observant" name="feats" value="Observant" />
                <label for="observant">Observant</label>
            </div>
            <div>
                <input type="checkbox" id="perceptive" name="feats" value="Perceptive" />
                <label for="perceptive">Perceptive</label>
            </div>
            <div>
                <input type="checkbox" id="quickFingered" name="feats" value="Quick-Fingered" />
                <label for="quickFingered">Quick-Fingered</label>
            </div>
            <div>
                <input type="checkbox" id="resilient" name="feats" value="Resilient" />
                <label for="resilient">Resilient</label>
            </div>
            <div>
                <input type="checkbox" id="savageAttacker" name="feats" value="Savage Attacker" />
                <label for="savageAttacker">Savage Attacker</label>
            </div>
            <div>
                <input type="checkbox" id="sentinel" name="feats" value="Sentinel" />
                <label for="sentinel">Sentinel</label>
            </div>
            <div>
                <input type="checkbox" id="skilled" name="feats" value="Skilled" />
                <label for="skilled">Skilled</label>
            </div>
            <div>
                <input type="checkbox" id="skulker" name="feats" value="Skulker" />
                <label for="skulker">Skulker</label>
            </div>
            <div>
                <input type="checkbox" id="stealthy" name="feats" value="Stealthy" />
                <label for="stealthy">Stealthy</label>
            </div>
            <div>
                <input type="checkbox" id="tough" name="feats" value="Tough" />
                <label for="tough">Tough</label>
            </div>
            <div>
                <input type="checkbox" id="typeAdept" name="feats" value="Type Adept" />
                <label for="typeAdept">Type Adept</label>
            </div>
            <div>
                <input type="checkbox" id="hiddenAbility" name="feats" value="Hidden Ability" />
                <label for="hiddenAbility">Hidden Ability</label>
            </div>
            <div>
                <input type="checkbox" id="extraMove" name="feats" value="Extra Move" />
                <label for="extraMove">Extra Move</label>
            </div>
            <div>
                <input type="checkbox" id="acUp" name="feats" value="AC Up" />
                <label for="acUp">AC Up</label>
            </div>
            <div>
                <input type="checkbox" id="tireless" name="feats" value="Tireless" />
                <label for="tireless">Tireless</label>
            </div>
            <div>
                <input type="checkbox" id="terrainAdept" name="feats" value="Terrain Adept" />
                <label for="terrainAdept">Terrain Adept</label>
            </div>
            <div>
                <input type="checkbox" id="comboMaster" name="feats" value="Combo Master" />
                <label for="comboMaster">Combo Master</label>
            </div>
            <div>
                <input type="checkbox" id="ableBodied" name="feats" value="Able-Bodied" />
                <label for="ableBodied">Able-Bodied</label>
            </div>
            <div>
                <input type="checkbox" id="powerSculptor" name="feats" value="Power Sculptor" />
                <label for="powerSculptor">Power Sculptor</label>
            </div>
            <div>
                <input type="checkbox" id="meleeMaster" name="feats" value="Melee Master" />
                <label for="meleeMaster">Melee Master</label>
            </div>
            <div>
                <input type="checkbox" id="rangedMaster" name="feats" value="Ranged Master" />
                <label for="rangedMaster">Ranged Master</label>
            </div>
        </div>




        <label for="heldItem">Held Item</label>
        <input type="text" id="heldItem" name="heldItem" list="heldItemList" autocomplete="off">
        <datalist id="heldItemList"></datalist>




        <label for="gear">Gear</label>
        <input type="text" id="gear" name="gear" list="gearList" autocomplete="off">
        <datalist id="gearList"></datalist>
        <button type="button" onclick="addGear()">Add Gear</button>
        <div id="gearContainer"></div>




        <label for="customMoves">Custom Moves</label>
        <input type="text" id="customMoves" name="customMoves" list="customMovesList" autocomplete="off">
        <datalist id="customMovesList"></datalist>
        <button type="button" onclick="addMove()">Add</button>
        <div id="customMovesContainer"></div>




        <button type="submit">Update Pokémon</button>
    </form>
</div>




<div class="pokeball-center"></div>
<div class="pokeball-button" onclick="goBack()">
    <span class="back-button-text">Back</span>
</div>




<div id="statChoicePopup" class="popup" style="display:none;">
    <div class="popup-content">
        <h2>Select Stat to Increase</h2>
        <div id="statOptions"></div>
    </div>
</div>




<audio id="level-up-audio">
  <source src="https://raw.githubusercontent.com/Scorelax/PokemonDnD/main/Level%20Up.mp3" type="audio/mpeg">
</audio>




<script>
    var statIncreases = [];




    function initializeEditPokemon() {
        console.log('initializeEditPokemon called');
        const selectedPokemonName = sessionStorage.getItem('selectedPokemonName');
        console.log('Selected Pokemon:', selectedPokemonName);
        const pokemonDataRaw = sessionStorage.getItem(`pokemon_${selectedPokemonName.toLowerCase()}`);
        console.log('Pokemon data found:', pokemonDataRaw ? 'Yes' : 'No');
        const selectedPokemonData = pokemonDataRaw ? JSON.parse(pokemonDataRaw) : null;
        const moves = JSON.parse(sessionStorage.getItem('moves')) || [];
        const items = JSON.parse(sessionStorage.getItem('items')) || [];
        const natures = JSON.parse(sessionStorage.getItem('natures')) || [];
        console.log(items);
        if (selectedPokemonData) {
            sessionStorage.setItem('tempCurrentLevel', selectedPokemonData[4]);
            document.title = `Edit ${selectedPokemonData[36] || selectedPokemonData[2]}`;
            document.getElementById('level').value = selectedPokemonData[4] || '';
            document.getElementById('hd').value = selectedPokemonData[9] || '';
            document.getElementById('vd').value = selectedPokemonData[11] || '';
            document.getElementById('str').value = selectedPokemonData[15] || '';
            document.getElementById('dex').value = selectedPokemonData[16] || '';
            document.getElementById('con').value = selectedPokemonData[17] || '';
            document.getElementById('int').value = selectedPokemonData[18] || '';
            document.getElementById('wis').value = selectedPokemonData[19] || '';
            document.getElementById('cha').value = selectedPokemonData[20] || '';
            document.getElementById('loyalty').value = (selectedPokemonData[33] || selectedPokemonData[33] === 0) ? selectedPokemonData[33] : '0';
            document.getElementById('heldItem').value = selectedPokemonData[35] || '';




            // Populate the nature dropdown
            const natureDropdown = document.getElementById('nature');
            natures.forEach(nature => {
                const option = document.createElement('option');
                option.value = nature.name;
                option.textContent = nature.name;
                natureDropdown.appendChild(option);
            });




            natureDropdown.value = selectedPokemonData[32] || natures[0].name;




            const skills = selectedPokemonData[22] ? selectedPokemonData[22].split(',').map(skill => skill.trim()) : [];
            skills.forEach(skill => {
                const checkbox = document.querySelector(`input[name="skills"][value="${skill}"]`);
                if (checkbox) checkbox.checked = true;
            });




            const feats = selectedPokemonData[50] ? selectedPokemonData[50].split(',').map(feat => feat.trim()) : [];
            feats.forEach(feat => {
                const checkbox = document.querySelector(`input[name="feats"][value="${feat}"]`);
                if (checkbox) checkbox.checked = true;
            });


            // Load abilities - check if completePokemonData is available, if not fetch it
            loadAbilities(selectedPokemonData);

            // Populate held item datalist
            const heldItemList = document.getElementById('heldItemList');
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                heldItemList.appendChild(option);
            });

            // Populate gear datalist
            const gearList = document.getElementById('gearList');
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                gearList.appendChild(option);
            });

            // Load existing gear chips
            const existingGear = selectedPokemonData[51] ? selectedPokemonData[51].split(',').map(gear => gear.trim()) : [];
            existingGear.forEach(gear => {
                if (gear) createGearChip(gear);
            });

            // Populate custom moves datalist
            const customMovesList = document.getElementById('customMovesList');
            moves.forEach(move => {
                const option = document.createElement('option');
                option.value = move[0];
                customMovesList.appendChild(option);
            });

            // Load existing custom moves chips
            const existingCustomMoves = selectedPokemonData[37] ? selectedPokemonData[37].split(',').map(move => move.trim()) : [];
            existingCustomMoves.forEach(move => {
                if (move) createMoveChip(move);
            });
        } else {
            console.error('No Pokemon data found!');
        }

        // Toggle Skills section
        const skillsLabel = document.querySelector('label[for="skills"]');
        const skillsSection = document.getElementById('skills');
        const skillsArrow = document.getElementById('skillsArrow');

        skillsLabel.addEventListener('click', () => {
            skillsSection.style.display = skillsSection.style.display === 'none' ? 'flex' : 'none';
            skillsArrow.classList.toggle('open');
        });

        // Toggle Feats section
        const featsLabel = document.querySelector('label[for="feats"]');
        const featsSection = document.getElementById('feats');
        const featsArrow = document.getElementById('featsArrow');

        featsLabel.addEventListener('click', () => {
            featsSection.style.display = featsSection.style.display === 'none' ? 'flex' : 'none';
            featsArrow.classList.toggle('open');
        });

        const abilitiesLabel = document.querySelector('label[for="abilities"]');
        const abilitiesSection = document.getElementById('abilities');
        const abilitiesArrow = document.getElementById('abilitiesArrow');

        if (abilitiesLabel && abilitiesSection && abilitiesArrow) {
            abilitiesLabel.addEventListener('click', () => {
                abilitiesSection.style.display = abilitiesSection.style.display === 'none' ? 'flex' : 'none';
                abilitiesArrow.classList.toggle('open');
            });
        }

        // Initialize sections as hidden
        skillsSection.style.display = 'none';
        featsSection.style.display = 'none';
        if (abilitiesSection) abilitiesSection.style.display = 'none';
    }

    function loadAbilities(selectedPokemonData) {
        const currentPokemonName = selectedPokemonData[2]; // Get the Pokemon's name
        console.log('Loading abilities for:', currentPokemonName);

        // Show loading indicator
        const abilitiesSection = document.getElementById('abilities');
        if (abilitiesSection) {
            abilitiesSection.innerHTML = '<div style="padding: 1rem; font-size: 1.5rem; color: #666;">Loading abilities...</div>';
        }

        // Call the optimized server function that only fetches abilities for this specific Pokemon
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.status === 'success') {
                    console.log('Fetched abilities in', response.executionTime, 'ms');
                    console.log('Abilities:', response.abilities);
                    populateAbilities(response.abilities, selectedPokemonData);
                } else {
                    console.error('Error fetching Pokemon abilities:', response.message);
                    if (abilitiesSection) {
                        abilitiesSection.innerHTML = '<div style="padding: 1rem; font-size: 1.5rem; color: #f44336;">Failed to load abilities</div>';
                    }
                    alert('Failed to load Pokemon abilities. Please try again.');
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error calling getPokemonAbilities:', error);
                if (abilitiesSection) {
                    abilitiesSection.innerHTML = '<div style="padding: 1rem; font-size: 1.5rem; color: #f44336;">Failed to load abilities</div>';
                }
                alert('Failed to load Pokemon abilities. Please try again.');
            })
            .getPokemonAbilities(currentPokemonName);
    }

    function populateAbilities(abilities, selectedPokemonData) {
        console.log('Populating', abilities.length, 'abilities');

        const abilitiesSection = document.getElementById('abilities');
        if (abilitiesSection) {
            abilitiesSection.innerHTML = '';

            abilities.forEach((abilityData, index) => {
                // New format from server: "slotIndex:Name, Description"
                // Extract slot index and ability data
                const colonIndex = abilityData.indexOf(':');
                let slotIndex = index; // Fallback to array index
                let abilityString = abilityData;

                if (colonIndex !== -1 && colonIndex < 3) {
                    slotIndex = parseInt(abilityData.substring(0, colonIndex));
                    abilityString = abilityData.substring(colonIndex + 1);
                }

                const parts = abilityString.split(',');
                const abilityName = parts[0].trim();
                const abilityDescription = parts.slice(1).join(',').trim();

                const div = document.createElement('div');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `ability${slotIndex}`;
                checkbox.name = 'abilities';
                // Store slotIndex:name;description format to preserve which slot this ability belongs to
                // slotIndex: 0 = primary, 1 = secondary, 2 = hidden
                checkbox.value = slotIndex + ':' + abilityName + ';' + abilityDescription;

                const label = document.createElement('label');
                label.htmlFor = `ability${slotIndex}`;
                label.innerHTML = `<strong>${abilityName}</strong>`;  // Only show the name in the UI

                div.appendChild(checkbox);
                div.appendChild(label);
                abilitiesSection.appendChild(div);
            });

            // Check currently selected abilities (from database at index 7)
            // Format is: "slotIndex:name;description|slotIndex:name;description"
            const currentAbilitiesRaw = selectedPokemonData[7] || '';
            const currentAbilities = currentAbilitiesRaw
                .split('|')  // Split by pipe to get individual abilities
                .map(ability => ability.trim())
                .filter(ability => ability);  // Remove empty strings

            console.log('Current abilities from database:', currentAbilities);

            currentAbilities.forEach(abilityData => {
                // Format: "slotIndex:name;description" or legacy "name;description"
                const colonIndex = abilityData.indexOf(':');

                if (colonIndex !== -1 && colonIndex < 3) {
                    // New format with slot index - check by slot ID
                    const slotIndex = abilityData.substring(0, colonIndex);
                    const abilityName = abilityData.substring(colonIndex + 1).split(';')[0].trim();
                    const checkbox = document.getElementById(`ability${slotIndex}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('Checked ability (by slot):', abilityName, 'slot:', slotIndex);
                    } else {
                        console.warn('Checkbox not found for slot:', slotIndex, 'ability:', abilityName);
                    }
                } else {
                    // Legacy format without slot index - match by name
                    const abilityName = abilityData.split(';')[0].trim();
                    const checkboxes = document.querySelectorAll('input[name="abilities"]');
                    checkboxes.forEach(checkbox => {
                        const checkboxValue = checkbox.value;
                        const checkboxColonIndex = checkboxValue.indexOf(':');
                        let checkboxAbilityName;

                        if (checkboxColonIndex !== -1) {
                            checkboxAbilityName = checkboxValue.substring(checkboxColonIndex + 1).split(';')[0].trim();
                        } else {
                            checkboxAbilityName = checkboxValue.split(';')[0].trim();
                        }

                        if (checkboxAbilityName.toLowerCase() === abilityName.toLowerCase()) {
                            checkbox.checked = true;
                            console.log('Checked ability (by name):', abilityName);
                        }
                    });
                }
            });
        }
    }

    // Function to add gear
    function addGear() {
        const gearInput = document.getElementById('gear');
        const selectedGear = gearInput.value.trim();
        if (selectedGear) {
            createGearChip(selectedGear);
            gearInput.value = '';
        }
    }




    // Function to create a gear chip (similar to the custom moves chip)
    function createGearChip(gear) {
        const container = document.getElementById('gearContainer');
        const chip = document.createElement('div');
        chip.className = 'custom-move-chip';
        chip.textContent = gear;
       
        const removeBtn = document.createElement('span');
        removeBtn.textContent = '×';
        removeBtn.onclick = () => container.removeChild(chip);
        chip.appendChild(removeBtn);
       
        container.appendChild(chip);
    }




    function addMove() {
        const moveInput = document.getElementById('customMoves');
        const selectedMove = moveInput.value.trim();
        if (selectedMove) {
            createMoveChip(selectedMove);
            moveInput.value = '';
        }
    }




    function createMoveChip(move) {
        const container = document.getElementById('customMovesContainer');
        const chip = document.createElement('div');
        chip.className = 'custom-move-chip';
        chip.textContent = move;
       
        const removeBtn = document.createElement('span');
        removeBtn.textContent = '×';
        removeBtn.onclick = () => container.removeChild(chip);
        chip.appendChild(removeBtn);
       
        container.appendChild(chip);
    }




    function submitForm(event) {
        event.preventDefault();
        NavigationManager.showSpinner();




        const form = document.getElementById("editPokemonForm");
        const formData = new FormData(form);




        const data = {};
        formData.forEach((value, key) => {
            if (key === "skills") {
                if (!data[key]) {
                    data[key] = [];
                }
                data[key].push(value);
            } else if (key === "feats") {
                if (!data.feats) {
                    data.feats = [];
                }
                data.feats.push(value);
            } else if (key === "abilities") {
                if (!data.abilities) {
                    data.abilities = [];
                }
                data.abilities.push(value);
            } else {
                data[key] = value;
            }
        });




        if (data.skills) {
            data.skills = data.skills.join(', ');
        }




        if (data.feats) {
            data.feats = data.feats.join(', ');
        }


        // Collect selected abilities (name;description format)
        if (data.abilities) {
            // abilities might be a single value or array depending on how FormData handles it
            if (!Array.isArray(data.abilities)) {
                data.abilities = [data.abilities];
            }
            // Use pipe separator for multiple abilities since descriptions may contain commas
            data.abilities = data.abilities.join('|');
        } else {
            data.abilities = '';
        }


        // Collect custom moves from the chips
        const customMovesContainer = document.getElementById('customMovesContainer');
        const customMoveChips = customMovesContainer.getElementsByClassName('custom-move-chip');
        const customMoves = [];
        for (let chip of customMoveChips) {
            customMoves.push(chip.textContent.replace('×', '').trim());
        }




        const gearContainer = document.getElementById('gearContainer');
        const gearChips = gearContainer.getElementsByClassName('custom-move-chip');
        const selectedGear = [];
        for (let chip of gearChips) {
            selectedGear.push(chip.textContent.replace('×', '').trim());
        }




        data.customMoves = customMoves.join(', ');
        data.gear = selectedGear.join(', ');




        const selectedPokemonName = sessionStorage.getItem('selectedPokemonName');
        const pokemonDataRaw = sessionStorage.getItem(`pokemon_${selectedPokemonName.toLowerCase()}`);
        const selectedPokemonData = pokemonDataRaw ? JSON.parse(pokemonDataRaw) : null;




        if (!selectedPokemonData) {
            console.error('No Pokémon data found in session storage for the selected Pokémon name.');
            alert('Could not find the Pokémon data. Please try again.');
            return;
        }




        const statMapping = {
            'strength': 'str',
            'dexterity': 'dex',
            'constitution': 'con',
            'intelligence': 'int',
            'wisdom': 'wis',
            'charisma': 'cha'
        };




        const currentNature = selectedPokemonData[32];
        const selectedNature = document.getElementById('nature').value;
        const natures = JSON.parse(sessionStorage.getItem('natures')) || [];




        if (selectedNature !== currentNature) {
            const oldNature = natures.find(n => n.name === currentNature);
            if (oldNature) {
                const oldBoostStat = oldNature.boostStat.toLowerCase();
                const oldNerfStat = oldNature.nerfStat.toLowerCase();
                const oldBoostStatKey = statMapping[oldBoostStat];
                const oldNerfStatKey = statMapping[oldNerfStat];




                if (oldBoostStatKey && data[oldBoostStatKey] !== undefined) {
                    data[oldBoostStatKey] = parseInt(data[oldBoostStatKey]) - parseInt(oldNature.boostAmount);
                }




                if (oldNerfStatKey && data[oldNerfStatKey] !== undefined) {
                    data[oldNerfStatKey] = parseInt(data[oldNerfStatKey]) + parseInt(oldNature.nerfAmount);
                }
            }




            const newNature = natures.find(n => n.name === selectedNature);
            if (newNature) {
                const boostStat = newNature.boostStat.toLowerCase();
                const nerfStat = newNature.nerfStat.toLowerCase();
                const boostStatKey = statMapping[boostStat];
                const nerfStatKey = statMapping[nerfStat];




                if (boostStatKey && data[boostStatKey] !== undefined) {
                    data[boostStatKey] = parseInt(data[boostStatKey]) + parseInt(newNature.boostAmount);
                }




                if (nerfStatKey && data[nerfStatKey] !== undefined) {
                    data[nerfStatKey] = parseInt(data[nerfStatKey]) - parseInt(newNature.nerfAmount);
                }
            } else {
                console.error('Nature not found or undefined:', selectedNature);
            }
        } else {
            console.log("Nature did not change, skipping boost/nerf application.");
        }




        const currentFeats = selectedPokemonData[50] ? selectedPokemonData[50].split(',').map(feat => feat.trim()) : [];
        const newFeats = (data.feats ? data.feats.split(',').map(feat => feat.trim()) : [])
          .filter(feat => !currentFeats.includes(feat));
        console.log("CURRENTSKILLS: ", selectedPokemonData[22]);
        console.log("CURRENTFEATS: ", currentFeats);
        console.log("NEWFEATS: ", newFeats);
        const removedFeats = currentFeats.filter(feat => !newFeats.includes(feat) && !(data.feats || "").includes(feat));
        console.log("REMOVEDFEATS: ", removedFeats);
        console.log("DATA: ", data);




        removedFeats.forEach(feat => {
            if (feat === "Acrobat") {
                data.dex = parseInt(data.dex,10) - 1;
                data.skills = data.skills.split(',').filter(skill => skill.trim() !== "Acrobatics").join(', ');
            }
            if (feat === "Actor") {
                data.cha = parseInt(data.cha,10) - 1;
            }
            if (feat === "Brawny") {
                data.str = parseInt(data.str,10) - 1;
                data.skills = data.skills.split(',').filter(skill => skill.trim() !== "Athletics").join(', ');
            }
            if (feat === "Durable") {
                data.con = parseInt(data.con,10) - 1;
            }
            if (feat === "Perceptive") {
                data.wis = parseInt(data.wis,10) - 1;
                data.skills = data.skills.split(',').filter(skill => skill.trim() !== "Perception").join(', ');
            }
            if (feat === "Quick-Fingered") {
                data.str = parseInt(data.str,10) - 1;
            }
            if (feat === "Stealthy") {
                data.dex = parseInt(data.dex,10) - 1;
                data.skills = data.skills.split(',').filter(skill => skill.trim() !== "Stealth").join(', ');
            }
            if (feat === "AC Up") {
                data.ac = parseInt(data.ac,10) - 1;
            }
        });




        console.log("selectedPokemonData[21]", selectedPokemonData[21]);




        const handleFeat = (index) => {
            if (index >= newFeats.length) {
                continueFormSubmission(data, selectedPokemonData, newFeats);
                return;
            }




            const feat = newFeats[index];
            if (feat === "Athlete" || feat === "Observant" || feat === "Resilient") {
                showStatChoicePopup(feat, (selectedStat) => {
                    if (!statIncreases) statIncreases = [];
                    if (feat === "Athlete") {
                        statIncreases[0] = selectedStat;
                    } else if (feat === "Observant") {
                        statIncreases[1] = selectedStat;
                    } else if (feat === "Resilient") {
                        statIncreases[2] = selectedStat;
                        console.log("SELECTEDSTAT: ", selectedStat);




                        // Map short stat to full name
                        const fullStatNames = {
                            "STR": "Strength",
                            "DEX": "Dexterity",
                            "CON": "Constitution",
                            "INT": "Intelligence",
                            "WIS": "Wisdom",
                            "CHA": "Charisma"
                        };
                        const fullStat = fullStatNames[selectedStat];




                        // Log current saving throws for debugging
                        console.log("Current Saving Throws (Before):", selectedPokemonData[21]);




                        // Initialize saving throws as an array or split existing ones
                        let savingThrows = selectedPokemonData[21]
                            ? selectedPokemonData[21].split(',').map(stat => stat.trim()).filter(stat => stat)
                            : [];




                        // Check if fullStat is already in saving throws
                        if (!savingThrows.includes(fullStat)) {
                            savingThrows.push(fullStat);  // Add full stat name if not present
                            selectedPokemonData[21] = savingThrows.join(', '); // Join array back to string
                            console.log(`Added ${fullStat} to Saving Throws`);
                        } else {
                            console.log(`${fullStat} already exists in Saving Throws`);
                        }




                        // Log updated saving throws for debugging
                        console.log("Updated Saving Throws (After):", selectedPokemonData[21]);
                    }




                    handleFeat(index + 1);
                });
            } else {
                handleFeat(index + 1);
            }
        };




        handleFeat(0);
    }




    function continueFormSubmission(data, selectedPokemonData, newFeats) {
        NavigationManager.showSpinner();
        // Update session storage and call calculateModifiers before updating Google Sheets
        let newPokemonData = updateSessionStorageWithNewPokemon(data, selectedPokemonData);
        const currentLevel = parseInt(sessionStorage.getItem('tempCurrentLevel'));
        sessionStorage.removeItem('tempCurrentLevel');




        google.script.run.withSuccessHandler((response) => {
            if (response && response.status === 'success') {
                newPokemonData = response.newPokemonData; // Update with calculated modifiers




                // Update the session storage
                sessionStorage.setItem(`pokemon_${selectedPokemonData[2].toLowerCase()}`, JSON.stringify(newPokemonData));




                // Update the Google Sheets
                google.script.run.withSuccessHandler((response) => {
                    if (response.status === 'success') {
                        if(currentLevel < newPokemonData[4]){
                          var levelUpAudio = document.getElementById('level-up-audio');
                          levelUpAudio.play();
                        }
                        NavigationManager.hideSpinner();
                        displayCustomMessage(`${newPokemonData[2]}'s info is updated!`);




                        NavigationManager.navigate('pokemon_card');
                    } else {
                        NavigationManager.hideSpinner();
                        displayCustomMessage('Failed to update Pokémon.');
                    }
                }).updatePokemonDataInSheet(newPokemonData);
            } else {
                displayCustomMessage('Failed to calculate modifiers.');
            }
        }).calculateModifiers(newPokemonData, statIncreases, newFeats);
    }




    function getStatIndex(statName) {
        const statMapping = {
            'strength': 0,
            'dexterity': 1,
            'constitution': 2,
            'intelligence': 3,
            'wisdom': 4,
            'charisma': 5,
            'ac': -7
        };
        return statMapping[statName] || 0;
    }




    function updateSessionStorageWithNewPokemon(data, selectedPokemonData) {
        let newPokemonData = [...selectedPokemonData];




        newPokemonData[4] = parseInt(data.level);
        newPokemonData[9] = parseInt(data.hd);
        newPokemonData[11] = parseInt(data.vd);
        newPokemonData[15] = parseInt(data.str);
        newPokemonData[16] = parseInt(data.dex);
        newPokemonData[17] = parseInt(data.con);
        newPokemonData[18] = parseInt(data.int);
        newPokemonData[19] = parseInt(data.wis);
        newPokemonData[20] = parseInt(data.cha);
        newPokemonData[33] = parseInt(data.loyalty);
        newPokemonData[35] = data.heldItem || '';
        newPokemonData[37] = data.customMoves || '';
        newPokemonData[22] = data.skills || '';
        newPokemonData[32] = data.nature || '';
        newPokemonData[50] = data.feats || '';
        newPokemonData[51] = data.gear || '';
        newPokemonData[7] = data.abilities || '';




        return newPokemonData;
    }




    function showStatChoicePopup(feat, onStatSelected) {
        NavigationManager.hideSpinner();
        const statOptionsDiv = document.getElementById('statOptions');
        statOptionsDiv.innerHTML = ''; // Clear previous options




        let options = [];
        if (feat === "Athlete") {
            options = ["STR", "DEX"];
        } else if (feat === "Observant") {
            options = ["INT", "WIS"];
        } else if (feat === "Resilient") {
            options = ["STR", "DEX", "CON", "INT", "WIS", "CHA"];
        }




        // Create buttons for each option with consistent styling
        options.forEach(stat => {
            const button = document.createElement('button');
            button.textContent = stat.toUpperCase();
            button.className = 'popup-button'; // Apply the consistent styling class
            button.onclick = () => {
                onStatSelected(stat); // Call the callback with the selected stat
                closeStatChoicePopup();
            };
            statOptionsDiv.appendChild(button);
        });




        document.getElementById('statChoicePopup').style.display = 'flex'; // Show the popup
    }




    function selectStat(feat, stat) {
        if (feat === "Athlete") {
            statIncreases[0] = stat;
        } else if (feat === "Observant") {
            statIncreases[1] = stat;
        } else if (feat === "Resilient") {
            statIncreases[2] = stat;
        }




        closeStatChoicePopup();
    }




    function closeStatChoicePopup() {
        document.getElementById('statChoicePopup').style.display = 'none';
    }
</script>
