BUGS FIXED IN THIS SESSION (2025-12-30)
========================================

BUG FIX #1: Held-item button not working in pokemon-card
---------------------------------------------------------
FIXED: The held items were not stored in window scope like abilities were.
- Added window.heldItems assignment (pokemon-card.js:1580)
- Updated event listener to use window.heldItems (pokemon-card.js:1894)

BUG FIX #2: Level 2 moves not saving to database
-------------------------------------------------
ROOT CAUSE FOUND: Database schema mismatch!
- Database expects 3 SEPARATE ability columns (primary, secondary, hidden) at indices 7, 8, 9
- Frontend was sending 1 COMBINED ability field, shifting everything by 2 positions
- This caused moves to go into the WRONG columns (level 2 moves went into skills column!)

FIXED in pokemon-form.js:
- Split abilities into 3 separate fields before creating newPokemonData array (lines 416-434)
- Now properly sends primaryAbility, secondaryAbility, hiddenAbility at indices 7, 8, 9 (lines 490-502)

FIXED in edit-pokemon.js:
- Updated to split abilities into 3 fields when saving (lines 1186-1203, 1220-1223)
- Added backward compatibility to read both old format (1 field) and new format (3 fields) (lines 1364-1379)
- Existing Pokemon will be automatically migrated when edited

FIXED in evolution.js:
- Added backward compatibility for reading abilities (lines 898-915)
- Split evolved abilities into 3 separate fields (lines 956-969)
- Updated evolvedPokemonData array structure (lines 972-983)

BUG FIX #3: Use Move button defaulting to "Circle Throw"
---------------------------------------------------------
ROOT CAUSE: Event listener captured stale `move` variable from closure when popup was created.
FIXED in pokemon-card.js:
- Modified event listener to read move data from button's dataset attributes (lines 2553-2563)
- Set dataset attributes when populating move details (lines 2654-2657)

BUG FIX #4: Type matchup calculation not working in pokemon-form
-----------------------------------------------------------------
ROOT CAUSE: Backend returns type effectiveness in `data` field, but frontend tried to access `effectiveness` field.
FIXED in pokemon-form.js:
- Changed `typeResponse.effectiveness` to `typeResponse.data` (line 486)
- evolution.js already had fallback to handle both formats

BUG FIX #5: Money field missing from trainer-info display
----------------------------------------------------------
FIXED in trainer-info.js:
- trainerMoney variable was already defined at line 35
- Added Money field display between Saving Throws and League Points (lines 1585-1588)

BUG FIX #6: Money field missing from edit-trainer
--------------------------------------------------
FIXED in edit-trainer.js:
- Added trainerMoney variable definition (line 26)
- Added Money input field in form (lines 493-496)
- Added code to get money value when saving (line 734)
- Added code to update trainerData[19] with money value (line 758)

BUG FIX #7: Pokemon registration array structure mismatch (CRITICAL)
------------------------------------------------------------------------
ROOT CAUSE: Database schema uses POKEMON_COLUMN_INDICES with 3 separate ability
fields (primaryability, secondaryability, hiddenability at indices 7, 8, 9), but
backend functions were using old hardcoded indices that expected a single ability
field. This caused ALL data after index 7 to be stored in wrong columns!

FIXED in Current_Code.gs (BACKEND):
- registerPokemonForTrainer() now uses POKEMON_COLUMN_INDICES constants
- storeTrainerAndPokemonData() reads using POKEMON_COLUMN_INDICES and transforms
  data to match frontend expectations (combines 3 abilities into 1 pipe-separated
  string for backward compatibility)

FIXED in js/pages/pokemon-form.js (FRONTEND):
- Moved senses from index 51 to correct position 41
- Moved feats from index 52 to correct position 42
- Reorganized extended fields to match schema

IMPORTANT: This fix requires deploying the updated Current_Code.gs to Google Apps
Script! See deployment steps below.

STILL TO FIX:
- Affinity/specialization/trainer-path selection logic (COMPLEX - see below)

NOTE ON AFFINITY/SPECIALIZATION/TRAINER-PATH SELECTION
-------------------------------------------------------
This bug fix is more complex than the others and requires porting the selection
system from the reference implementation (_reference/trainer_info.html).

Current behavior:
- When affinity/specialization/trainer-path are "None", popups just show message
- No way to select/change these values from the UI

Required changes (from reference implementation):
1. Add new HTML popups for selection:
   - affinitySelectionPopup (with affinity-grid for choices)
   - specializationSelectionPopup (with specialization-grid for choices)
   - Trainer path: inline selection in existing popup when no path chosen

2. Add CSS styling for:
   - .affinity-grid, .affinity-item, .affinity-selection-effect-box
   - .specialization-grid, .specialization-item, .specialization-selection-effect-box
   - Selection button states and hover effects

3. JavaScript logic to implement:
   - showAffinitySelection(availableAffinities, selectedAffinities)
   - selectAffinity(affinity) - shows effect in selection box
   - saveAffinity(selectedAffinity) - saves to backend via API
   - Similar functions for specialization
   - Trainer path: inline clickable items when none chosen

4. Backend API endpoints needed:
   - writeAffinity(trainerName, affinityString)
   - writeSpecialization(trainerName, specializationString)
   - writeTrainerPath(trainerName, trainerPathName)

This should be implemented as a separate feature after testing the other bug fixes.

========================================

CRITICAL: DEPLOY CURRENT_CODE.GS TO GOOGLE APPS SCRIPT
=======================================================

The bug fix #7 requires deploying the updated Current_Code.gs to Google Apps Script.
Without this deployment, Pokemon registration will continue to fail!

DEPLOYMENT STEPS:
1. Go to your Google Apps Script project
2. Open the Code.gs file
3. Copy the ENTIRE contents of "Current_Code.gs" from your local project
4. Paste it into the Apps Script editor, replacing all existing code
5. Save the file (Ctrl+S or File > Save)
6. Click "Deploy" > "Manage deployments"
7. Click the "Edit" icon (pencil) next to your existing deployment
8. Under "Version", select "New version"
9. Add description: "Fix Pokemon registration array structure mismatch"
10. Click "Deploy"
11. Test registering a new Pokemon in the app
12. If it works, check the Google Sheet to verify data is in correct columns

========================================

DEPLOYMENT STEPS FOR POKEDEX CONFIG CHANGES
==============================================

STEP 1: Update GitHub Repository (IMPORTANT - Do this first!)
--------------------------------------------------------------
Make sure the repository owner (Benjakronk) has created and uploaded the
pokedex_config.json file to:

https://raw.githubusercontent.com/Benjakronk/shima-pokedex/main/pokedex_config.json

The file should have the structure shown in your New_RegisteredPokemon.json example.
If this file doesn't exist yet, the backend will fail when trying to fetch it.

You can test if it exists by visiting that URL in your browser.
If you get a 404 error, the file hasn't been created yet.


STEP 2: Update Google Apps Script
----------------------------------
1. Go to your Google Apps Script project
2. Open the Code.gs file (or whatever you named your main script file)
3. Copy the ENTIRE contents of "Current_Code.gs" from your local project
4. Paste it into the Apps Script editor, replacing all existing code
5. Save the file (Ctrl+S or File > Save)


STEP 3: Deploy New Version
---------------------------
1. Click "Deploy" > "Manage deployments" in the Apps Script editor
2. Click the "Edit" icon (pencil) next to your existing deployment
3. Under "Version", select "New version"
4. Optionally add a description like "Added Pokedex config and visibility support"
5. Click "Deploy"
6. Copy the new Web App URL if it changed (though it usually stays the same)


STEP 4: Frontend is Already Ready
----------------------------------
The frontend changes are already in your local files (committed to git):
- js/api.js - updated
- js/utils/visibility.js - new file created
- js/pages/pokemon-form.js - updated
- js/pages/edit-pokemon.js - updated
- js/pages/evolution.js - updated

Since you're running the app locally/from files, these are already in place.
No action needed here.


STEP 5: Test the Changes
-------------------------
After deploying:
1. Clear your browser cache or do a hard refresh (Ctrl+Shift+R)
2. Load the app
3. Try registering a Pokemon or editing one
4. Check the browser console (F12) for any errors
5. Verify that hidden abilities appear/don't appear based on the config


IMPORTANT NOTES
---------------
- The backend change is critical - without deploying the new Current_Code.gs,
  the frontend won't be able to fetch the Pokedex config

- The old URL won't work anymore - once you deploy, make sure pokedex_config.json
  exists, otherwise registered Pokemon won't load

- Cache will help - if the new URL fails, the backend will fall back to cached data


IF SOMETHING GOES WRONG (Rollback Steps)
-----------------------------------------
If you need to rollback quickly:
1. Go to Apps Script > Deploy > Manage deployments
2. Click Edit on the deployment
3. Change "Version" back to a previous version
4. Click Deploy


SUMMARY OF WHAT CHANGED
------------------------
Backend (Current_Code.gs):
- Changed REGISTERED_POKEMON_URL from registered_pokemon.json to pokedex_config.json
- Added caching for full Pokedex config
- Added getPokedexConfig() function
- Added 'pokedex-config' route to API

Frontend:
- Created visibility helper system (js/utils/visibility.js)
- Updated pokemon-form, edit-pokemon, and evolution pages to hide hidden abilities
  when not visible in the config
- Added API method to fetch Pokedex config


WHAT THE NEW CONFIG FILE SHOULD LOOK LIKE
------------------------------------------
The pokedex_config.json file should have this structure:

{
  "registered": [
    "Octuber",
    "Salamandrop",
    "Hydrasylph"
  ],
  "visibility": {
    "octuber": {
      "types": true,
      "description": true,
      "characteristics": true,
      "primaryAbility": true,
      "secondaryAbility": true,
      "hiddenAbility": true,
      "stats": true,
      "senses": true,
      "evolution": true,
      "moves": true,
      "movesMaxLevel": 6,
      "extraVisibleMoves": []
    },
    "salamandrop": {
      "types": false,
      "description": true,
      "characteristics": false,
      "primaryAbility": false,
      "secondaryAbility": false,
      "hiddenAbility": false,
      "stats": false,
      "senses": false,
      "evolution": false,
      "moves": false,
      "movesMaxLevel": 1,
      "extraVisibleMoves": []
    }
  },
  "defaults": {
    "types": false,
    "description": true,
    "characteristics": false,
    "primaryAbility": false,
    "secondaryAbility": false,
    "hiddenAbility": false,
    "stats": false,
    "senses": false,
    "evolution": false,
    "moves": false,
    "movesMaxLevel": 1,
    "extraVisibleMoves": []
  },
  "extraSearchableMoves": [],
  "splashCount": 45
}
